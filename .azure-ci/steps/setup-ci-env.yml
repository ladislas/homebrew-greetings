# File: .azure-ci/setup-ci-env.yml

parameters:
   xcode: 'Xcode_10.2'

steps:

  - bash: |
      printenv
    displayName: Azure printenv

  - bash: |
      set -ex
      sudo xcode-select --switch /Applications/$XCODE_VERSION.app/Contents/Developer
      echo "fork variable: $(fork.secret)"
      echo "fork variable: $FORK_SECRET"
      echo "git user: $(github_user)"
      echo "git user: $GU"
      brew unlink parallel
      brew install moreutils tree
      (git -C /usr/local/Homebrew fetch origin --tags) | ts -i
      (git -C /usr/local/Homebrew reset --hard origin/master) | ts -i
      brew update | ts -i
    displayName: Setup CI Environment
    env:
      XCODE_VERSION: ${{ parameters.xcode }}
      FORK_SECRET: $(fork.secret)
      GU: $(github_user)

  - bash: |
      if [[ -n "$SYSTEM_PULLREQUEST_PULLREQUESTNUMBER" ]]; then
        git fetch origin "master:master" "pull/$SYSTEM_PULLREQUEST_PULLREQUESTNUMBER/head:pr"
        git checkout pr
      fi
    displayName: Checkout PR $(System.PullRequest.PullRequestNumber) branch
