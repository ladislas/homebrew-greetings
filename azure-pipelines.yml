# File: azure-pipelines.yml

trigger:
  branches:
    include:
    - master


pr:
  branches:
    include:
    - master
    - develop
  paths:
    exclude:
    - README.md
  #   - .azure-ci/*
  #   - azure-pipelines.yml


variables:

  - group: bintray
  - group: github
  - group: ssh

  - name: brew_tap_path
    value: /usr/local/Homebrew/Library/Taps

  - name: test_bot_repo
    value: ladislas/homebrew-test-bot
  - name: test_bot_repo_branch
    value: feature/fix-azure-tap-modified-formulae-detection
  - name: test_bot_homebrew_repo
    value: homebrew/homebrew-test-bot

  # Github variables
  - name: github_user
    value: ladislas
  - name: github_email
    value: ladislas@detoldi.me
  - name: github_tap_repo
    value: homebrew-greetings

  # Bintray variables
  - name: bintray_org
    value: ladislas
  - name: bintray_repo
    value: greetings
  - name: bintray_root_url # computed, do not change
    value: https://dl.bintray.com/$(bintray_org)/bottles-$(bintray_repo)

  - name: ssh_hostname
    value: $(ssh.hostname)
  - name: ssh_public_key
    value: $(ssh.public_key)
  # - name: ssh_passphraseds
  #   value: $(ssh.passphrase)
  - name: ssh_secure_file
    value: $(ssh.secure_file)

  - name: HOMEBREW_BINTRAY_KEY
    value: $(bintray.key)
  - name: HOMEBREW_BINTRAY_USER
    value: $(bintray.user)

  - name: UPSTREAM_GIT_URL
    value: $(Build.Repository.Uri)
  - name: UPSTREAM_PULL_REQUEST
    value: $(System.PullRequest.PullRequestNumber)


stages:

  #########
  # Stage 1 - Testing formulae on `master`
  #########
  - stage: stage_testing_formulae_on_master
    displayName: Testing Formulae on master

    condition: eq(variables['Build.Reason'], 'IndividualCI')

    jobs:
      - template: .azure-ci/jobs/test_template.yml
        parameters:
          name: test_stage_testing_formulae_on_master
          message: Testing Formulae on master

  #########
  # Stage 2 - Cron job to test formulae
  #########
  - stage: stage_cron_job_on_master
    displayName: Cron job  on master

    condition: eq(variables['Build.Reason'], 'Schedule')

    jobs:
      - template: .azure-ci/jobs/test_template.yml
        parameters:
          name: test_stage_cron_job_on_master
          message: Cron job on master

  #########
  # Stage 3 - Building bottles on PR
  #########
  - stage: stage_build_bottle
    displayName: Build bottles

    condition: eq(variables['Build.Reason'], 'PullRequest')

    jobs:
      - template: .azure-ci/jobs/test_template.yml
        parameters:
          name: test_stage_build_bottle
          message: Build bottles
      # - template: .azure-ci/brew_test_bot.yml
      #   parameters:
      #     name: brew_test_bot_macOS_10_14
      #     displayName: for macOS Mojave (10.14)
      #     vmImage: macOS-10.14
      #     xcode: Xcode_10.2

      # - template: .azure-ci/brew_test_bot.yml
      #   parameters:
      #     name: brew_test_bot_macOS_10_13
      #     displayName: for macOS High Sierra (10.13)
      #     vmImage: macOS-10.13
      #     xcode: Xcode_10.1

  #########
  # Stage 4 - Uploading bottles to Bintray
  #########
  - stage: stage_upload_bottles
    displayName: Upload bottles

    dependsOn:
      - stage_build_bottle

    condition: and(succeeded('stage_build_bottle'), eq(variables['Build.Reason'], 'PullRequest'))

    jobs:
      - template: .azure-ci/jobs/test_template.yml
        parameters:
          name: test_stage_upload_bottles
          message: Upload bottles
      # - template: .azure-ci/brew_test_bot_ci_upload.yml
      #   parameters:
      #     name: Upload bottles

  #########
  # Stage 5 - Auto publish revision bumps
  #########
  - stage: stage_publish_revision_bump
    displayName: Publish revision bump

    dependsOn:
      - stage_upload_bottles

    condition: |
      and(
        succeeded('stage_upload_bottles'),
        eq(variables['Build.Reason'], 'PullRequest'),
        not(variables['System.PullRequest.IsFork']),
        contains(variables['System.PullRequest.SourceBranch'], 'revision-bump')
      )

    jobs:
      - template: .azure-ci/jobs/test_template.yml
        parameters:
          name: test_stage_publish_revision_bump
          message: Publish revision bump

      - job: test_pr_message_condition
        displayName: Test PR message condition

        pool:
          vmImage: macOS-10.14

        steps:

        - bash: |
            echo "The PR can be merged as the name is ok"
            git log
            git show
            echo $RANDOM
          displayName: Step - Test PR message condition
